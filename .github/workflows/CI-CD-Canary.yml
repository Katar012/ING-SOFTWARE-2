name: CI/CD Pipeline con Despliegue Canary

on:
  push:
    branches: ["main", "develop", "gomez"]
  pull_request:
    branches: ["main", "gomez"]

# Permisos necesarios para GHCR
permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: joseligos/ingsoft2/serviciudadcali
  COVERAGE_THRESHOLD: 80

jobs:
  # ==============================================================
  # JOB 1: Build, Test y VerificaciÃ³n de Cobertura
  # ==============================================================
  build-and-test:
    name: Build, Tests y Cobertura
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: ğŸ”¢ Generar versiÃ³n
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ VersiÃ³n generada: $VERSION"

      - name: ğŸ—ï¸ Compilar proyecto
        run: |
          cd ServiCiudadCali
          mvn -B clean compile -DskipTests
          echo "âœ… CompilaciÃ³n exitosa"

      - name: ğŸ§ª Ejecutar pruebas unitarias con cobertura
        run: |
          cd ServiCiudadCali
          mvn -B test jacoco:report
          echo "âœ… Tests ejecutados: $?"

      - name: ğŸ“Š Verificar umbral de cobertura (â‰¥80%)
        id: coverage
        run: |
          cd ServiCiudadCali
          
          # Extraer porcentaje de cobertura del reporte (ya generado por mvn test)
          COVERAGE=$(grep -oP 'Total.*?<td class="ctr2">\K[0-9]+' target/site/jacoco/index.html | head -1)
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Cobertura de cÃ³digo: $COVERAGE%"
          
          # Verificar umbral con mvn verify (incluye jacoco:check)
          if ! mvn verify -DskipTests; then
            echo "âŒ ERROR: VerificaciÃ³n de cobertura fallÃ³"
            exit 1
          fi
          
          if [ "$COVERAGE" -lt "$COVERAGE_THRESHOLD" ]; then
            echo "âŒ ERROR: Cobertura $COVERAGE% es menor que el umbral $COVERAGE_THRESHOLD%"
            exit 1
          fi
          echo "âœ… Cobertura cumple con el umbral requerido"

      - name: ğŸ“¦ Empaquetar aplicaciÃ³n
        run: |
          cd ServiCiudadCali
          mvn -B package -DskipTests
          echo "âœ… AplicaciÃ³n empaquetada"

      - name: ğŸ“¤ Subir artefacto JAR
        uses: actions/upload-artifact@v4
        with:
          name: serviciudadcali-${{ steps.version.outputs.version }}
          path: ServiCiudadCali/target/*.jar
          retention-days: 5

      - name: ğŸ“¤ Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ServiCiudadCali/target/site/jacoco/
          retention-days: 30

      - name: ğŸ“‹ Publicar reporte de cobertura en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.percentage }}';
            const threshold = '${{ env.COVERAGE_THRESHOLD }}';
            const status = coverage >= threshold ? 'âœ…' : 'âŒ';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“Š Reporte de Cobertura de CÃ³digo\n\n` +
                    `${status} **Cobertura:** ${coverage}%\n` +
                    `ğŸ¯ **Umbral requerido:** ${threshold}%\n\n` +
                    `${coverage >= threshold ? 'âœ… Cobertura cumple con los requisitos' : 'âŒ Cobertura por debajo del umbral'}`
            });

  # ==============================================================
  # JOB 2: Build de Imagen Docker
  # ==============================================================
  build-docker-image:
    name: Build Docker Image
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar artefacto JAR
        uses: actions/download-artifact@v4
        with:
          name: serviciudadcali-${{ needs.build-and-test.outputs.version }}
          path: ServiCiudadCali/target/

      - name: ğŸ” Login a GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build imagen Docker NUEVA (Canary)
        run: |
          cd ServiCiudadCali
          VERSION=${{ needs.build-and-test.outputs.version }}
          IMAGE_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          VCS_REF=${{ github.sha }}
          
          # Build con Docker Compose pasando argumentos de metadata
          VERSION=$VERSION BUILD_DATE=$BUILD_DATE VCS_REF=$VCS_REF docker compose -f docker-compose.build.yml build
          
          # Esta es la NUEVA versiÃ³n - etiquetar localmente
          docker tag serviciudadcali:latest serviciudadcali:canary
          docker tag serviciudadcali:latest serviciudadcali:$VERSION
          
          # Etiquetar para GHCR
          docker tag serviciudadcali:latest ${IMAGE_BASE}:canary
          docker tag serviciudadcali:latest ${IMAGE_BASE}:${VERSION}
          
          echo "âœ… Imagen NUEVA creada: serviciudadcali:canary (versiÃ³n $VERSION)"

      - name: ğŸ“¤ Subir imagen Canary a GHCR
        run: |
          VERSION=${{ needs.build-and-test.outputs.version }}
          IMAGE_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          
          # Subir la nueva versiÃ³n como 'canary' y con su versiÃ³n especÃ­fica
          docker push ${IMAGE_BASE}:canary
          docker push ${IMAGE_BASE}:${VERSION}
          
          echo "âœ… Imagen Canary subida a GHCR:"
          echo "   - ${IMAGE_BASE}:canary"
          echo "   - ${IMAGE_BASE}:${VERSION}"

      - name: ğŸ’¾ Guardar imagen Canary localmente (para artefacto)
        run: |
          docker save serviciudadcali:canary | gzip > serviciudadcali-canary.tar.gz
          echo "âœ… Imagen Canary guardada localmente"

      - name: ğŸ“¤ Subir imagen Canary como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-canary
          path: serviciudadcali-canary.tar.gz
          retention-days: 7

  # ==============================================================
  # JOB 3: Despliegue Canary
  # ==============================================================
  canary-deploy:
    name: Despliegue Canary
    needs: [build-and-test, build-docker-image]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Login a GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Descargar imagen Canary (nueva)
        uses: actions/download-artifact@v4
        with:
          name: docker-image-canary
          path: .

      - name: ğŸ“¦ Cargar imagen Canary (nueva)
        run: |
          docker load < serviciudadcali-canary.tar.gz
          echo "âœ… Imagen Canary (NUEVA versiÃ³n) cargada"

      - name: ğŸ“¥ Verificar y descargar imagen Stable anterior de GHCR
        run: |
          IMAGE_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          
          # Intentar descargar la imagen stable del registry
          if docker pull ${IMAGE_BASE}:stable 2>/dev/null; then
            echo "âœ… Imagen STABLE anterior encontrada en GHCR"
            # Etiquetar localmente para usar con docker-compose
            docker tag ${IMAGE_BASE}:stable serviciudadcali:stable
            
            # Obtener la versiÃ³n del stable
            STABLE_VERSION=$(docker inspect ${IMAGE_BASE}:stable --format='{{range .Config.Labels}}{{println .}}{{end}}' | grep -oP 'version=\K[^"]+' || echo "unknown")
            echo "ğŸ“¦ VersiÃ³n STABLE descargada: ${STABLE_VERSION}"
            echo "STABLE_EXISTS=true" >> $GITHUB_ENV
            echo "STABLE_VERSION=${STABLE_VERSION}" >> $GITHUB_ENV
          else
            echo "â„¹ï¸  No hay imagen STABLE anterior en GHCR (primer despliegue)"
            echo "STABLE_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: ğŸ³ Configurar y levantar servicios con Docker Compose
        run: |
          cd ServiCiudadCali
          VERSION=${{ needs.build-and-test.outputs.version }}
          
          # Detener contenedores previos si existen
          docker compose --profile canary stop app-canary 2>/dev/null || true
          docker compose --profile canary rm -f app-canary 2>/dev/null || true
          docker compose stop app-stable 2>/dev/null || true
          docker compose rm -f app-stable 2>/dev/null || true
          
          # Levantar MySQL si no estÃ¡ corriendo
          docker compose up -d mysql
          
          # Esperar que MySQL estÃ© listo
          sleep 10
          
          # Verificar si hay versiÃ³n stable en GHCR (no en docker ps)
          if [ "$STABLE_EXISTS" = "false" ]; then
            echo "=========================================="
            echo "âš ï¸  PRIMER DESPLIEGUE - No hay versiÃ³n stable en GHCR"
            echo "=========================================="
            
            # En el PRIMER despliegue, la imagen canary se convierte en stable
            docker tag serviciudadcali:canary serviciudadcali:stable
            
            # Desplegar como stable (serÃ¡ la versiÃ³n base para futuros canary)
            VERSION=${VERSION} docker compose up -d app-stable
            echo "âœ… Primera versiÃ³n desplegada como STABLE en puerto 8080"
            sleep 20
            
            echo ""
            echo "â„¹ï¸  Nota: Este es el primer despliegue, no hay Canary aÃºn"
            echo "â„¹ï¸  En el prÃ³ximo push, esta versiÃ³n serÃ¡ 'stable' (vieja)"
            echo "â„¹ï¸  y la nueva serÃ¡ 'canary' para comparaciÃ³n"
          else
            echo "=========================================="
            echo "âœ… DESPLIEGUE CANARY - Stable existe en GHCR"
            echo "=========================================="
            
            echo "ğŸ“¦ VersiÃ³n STABLE actual (vieja del push anterior): $STABLE_VERSION"
            echo "ğŸ“¦ VersiÃ³n CANARY nueva (del push actual): $VERSION"
            echo ""
            
            # Desplegar AMBAS versiones:
            # 1. STABLE (versiÃ³n VIEJA del push anterior)
            STABLE_VERSION_NUM=$(echo "$STABLE_VERSION" | grep -oP '[0-9.]+' || echo "1.0.0")
            VERSION=$STABLE_VERSION_NUM docker compose up -d app-stable
            
            # 2. CANARY (versiÃ³n NUEVA del push actual)
            VERSION=$VERSION docker compose --profile canary up -d app-canary
            
            echo "âœ… Despliegue Canary completado:"
            echo "ğŸ”— Puerto 8080: STABLE v${STABLE_VERSION} (versiÃ³n VIEJA - push anterior)"
            echo "ğŸ”— Puerto 8081: CANARY v${VERSION} (versiÃ³n NUEVA - push actual)"
          fi
          
          # Mostrar estado de contenedores
          echo ""
          echo "ğŸ“Š Estado de contenedores:"
          docker compose ps
          docker compose --profile canary ps

      - name: â³ Esperar inicializaciÃ³n
        run: |
          cd ServiCiudadCali
          
          # Verificar quÃ© se desplegÃ³
          if docker ps | grep -q "serviciudadcali-canary"; then
            echo "â³ Esperando a que la aplicaciÃ³n CANARY inicie..."
            echo "â³ Esperando 45 segundos para que Spring Boot arranque completamente..."
            sleep 45
            
            echo ""
            echo "ğŸ“ Ãšltimas lÃ­neas de logs de Canary:"
            docker logs --tail 30 serviciudadcali-canary || true
          elif docker ps | grep -q "serviciudadcali-stable"; then
            echo "â³ Esperando a que la aplicaciÃ³n STABLE (primer despliegue) inicie..."
            echo "â³ Esperando 45 segundos para que Spring Boot arranque completamente..."
            sleep 45
            
            echo ""
            echo "ğŸ“ Ãšltimas lÃ­neas de logs de Stable:"
            docker logs --tail 30 serviciudadcali-stable || true
          fi

      - name: ğŸ” Health Check
        run: |
          cd ServiCiudadCali
          
          # Determinar quÃ© servicio verificar
          if docker ps | grep -q "serviciudadcali-canary"; then
            echo "ğŸ” Verificando health de versiÃ³n CANARY..."
            SERVICE="canary"
            CONTAINER="serviciudadcali-canary"
            PORT="8081"
          elif docker ps | grep -q "serviciudadcali-stable"; then
            echo "ğŸ” Verificando health de versiÃ³n STABLE (primer despliegue)..."
            SERVICE="stable"
            CONTAINER="serviciudadcali-stable"
            PORT="8080"
          else
            echo "âŒ ERROR: No hay ningÃºn servicio corriendo"
            docker compose ps
            exit 1
          fi
          
          echo "ğŸ¯ Verificando: $SERVICE en puerto $PORT"
          
          # Verificar que el contenedor estÃ¡ corriendo
          if ! docker ps | grep -q "$CONTAINER"; then
            echo "âŒ ERROR: Contenedor $CONTAINER no estÃ¡ corriendo"
            echo "ğŸ“ Logs del contenedor:"
            docker logs $CONTAINER || true
            exit 1
          fi
          
          # Verificar conectividad
          echo "ğŸ” Verificando que el puerto $PORT estÃ¡ accesible..."
          
          MAX_RETRIES=15
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            echo "â³ Intento $RETRY_COUNT/$MAX_RETRIES..."
            
            if curl -f http://localhost:${PORT}/actuator/health 2>&1 | grep -q "UP"; then
              echo "âœ… Health check exitoso!"
              curl http://localhost:${PORT}/actuator/health
              exit 0
            fi
            
            if [ $RETRY_COUNT -eq 5 ] || [ $RETRY_COUNT -eq 10 ]; then
              echo "ğŸ“ Logs recientes (intento $RETRY_COUNT):"
              docker logs --tail 20 $CONTAINER || true
            fi
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 5
            fi
          done
          
          echo "âŒ Health check fallÃ³ despuÃ©s de $MAX_RETRIES intentos"
          echo ""
          echo "ğŸ“ Logs completos del contenedor $CONTAINER:"
          docker logs $CONTAINER || true
          echo ""
          echo "ğŸ“Š Estado de todos los contenedores:"
          docker compose ps
          docker compose --profile canary ps
          exit 1

      - name: ğŸ§ª Smoke Tests
        run: |
          cd ServiCiudadCali
          
          # Determinar quÃ© servicio probar
          if docker ps | grep -q "serviciudadcali-canary"; then
            echo "ğŸ§ª Ejecutando smoke tests en versiÃ³n CANARY..."
            PORT="8081"
            SERVICE="Canary"
          elif docker ps | grep -q "serviciudadcali-stable"; then
            echo "ğŸ§ª Ejecutando smoke tests en versiÃ³n STABLE (primer despliegue)..."
            PORT="8080"
            SERVICE="Stable"
          else
            echo "âŒ No hay servicio para probar"
            exit 1
          fi
          
          echo "ğŸ¯ Probando $SERVICE en puerto $PORT"
          
          # Test 1: Endpoint principal
          echo "ğŸ“ Test 1: GET /"
          if curl -f http://localhost:${PORT}/ 2>&1; then
            echo "âœ… Test 1 pasÃ³"
          else
            echo "âš ï¸  Test 1 fallÃ³ (puede ser esperado si no hay endpoint raÃ­z)"
          fi
          
          # Test 2: Health check
          echo "ğŸ“ Test 2: GET /actuator/health"
          curl -f http://localhost:${PORT}/actuator/health || exit 1
          echo "âœ… Test 2 pasÃ³"
          
          echo ""
          echo "âœ… Smoke tests completados exitosamente"

      - name: ğŸ“Š MÃ©tricas
        run: |
          cd ServiCiudadCali
          
          # Determinar quÃ© servicio mostrar
          if docker ps | grep -q "serviciudadcali-canary"; then
            echo "ğŸ“Š MÃ©tricas de versiÃ³n CANARY..."
            CONTAINER="serviciudadcali-canary"
            PORT="8081"
            SERVICE="Canary"
          elif docker ps | grep -q "serviciudadcali-stable"; then
            echo "ğŸ“Š MÃ©tricas de versiÃ³n STABLE (primer despliegue)..."
            CONTAINER="serviciudadcali-stable"
            PORT="8080"
            SERVICE="Stable"
          else
            echo "âš ï¸  No hay contenedor activo"
            exit 0
          fi
          
          echo "ğŸ“Š Recolectando mÃ©tricas de $SERVICE..."
          echo "ğŸ”— URL: http://localhost:${PORT}"
          echo "ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ“Š Cobertura: ${{ needs.build-and-test.outputs.coverage }}%"
          
          # Obtener informaciÃ³n del contenedor
          docker ps -f name=${CONTAINER} --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # Logs recientes
          echo ""
          echo "ğŸ“ Ãšltimas 20 lÃ­neas de logs:"
          docker logs --tail 20 ${CONTAINER}

      - name: â¸ï¸ Resumen
        run: |
          cd ServiCiudadCali
          
          if docker ps | grep -q "serviciudadcali-canary"; then
            echo "âœ… VersiÃ³n Canary desplegada exitosamente"
            echo "ğŸ¯ La versiÃ³n Canary estÃ¡ lista para recibir trÃ¡fico de prueba"
            echo ""
            echo "ğŸ“‹ InformaciÃ³n:"
            echo "  ğŸ”— URL Stable (vieja): http://localhost:8080"
            echo "  ğŸ”— URL Canary (nueva): http://localhost:8081"
            echo "  ğŸ“¦ VersiÃ³n Canary: ${{ needs.build-and-test.outputs.version }}"
            echo ""
            echo "ğŸ“‹ PrÃ³ximos pasos:"
            echo "  1. Monitorear mÃ©tricas y logs"
            echo "  2. Si todo va bien â†’ Job promote-to-production"
            echo "  3. Si hay problemas â†’ Job rollback"
          else
            echo "âœ… Primera versiÃ³n desplegada como STABLE"
            echo "â„¹ï¸  Este fue el primer despliegue - no hay Canary aÃºn"
            echo ""
            echo "ğŸ“‹ InformaciÃ³n:"
            echo "  ğŸ”— URL Stable: http://localhost:8080"
            echo "  ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
            echo ""
            echo "â„¹ï¸  En el prÃ³ximo push:"
            echo "  - Esta versiÃ³n serÃ¡ 'stable' (vieja) en puerto 8080"
            echo "  - La nueva versiÃ³n serÃ¡ 'canary' (nueva) en puerto 8081"
          fi

  # ==============================================================
  # JOB 4: PromociÃ³n a ProducciÃ³n (Manual)
  # ==============================================================
  promote-to-production:
    name: Promover Canary a ProducciÃ³n
    needs: [build-and-test, canary-deploy]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Nota: Requiere aprobaciÃ³n manual en GitHub Actions
    # Para activar, configurar environment 'production' en Settings > Environments
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Login a GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Descargar imagen Canary (nueva)
        uses: actions/download-artifact@v4
        with:
          name: docker-image-canary
          path: .

      - name: ğŸ“¦ Cargar imagen Canary
        run: |
          docker load < serviciudadcali-canary.tar.gz
          echo "âœ… Imagen Canary (nueva versiÃ³n) cargada"

      - name: ğŸ”„ Backup versiÃ³n Stable actual (la vieja) en GHCR
        run: |
          IMAGE_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          
          # Descargar stable actual de GHCR (si existe)
          if docker pull ${IMAGE_BASE}:stable 2>/dev/null; then
            # Hacer backup etiquetÃ¡ndola como rollback
            docker tag ${IMAGE_BASE}:stable ${IMAGE_BASE}:rollback
            docker push ${IMAGE_BASE}:rollback
            
            STABLE_VERSION=$(docker inspect ${IMAGE_BASE}:stable --format='{{range .Config.Labels}}{{println .}}{{end}}' | grep -oP 'version=\K[^"]+' || echo "unknown")
            echo "âœ… Backup de versiÃ³n stable (v${STABLE_VERSION}) guardado en GHCR como :rollback"
          else
            echo "â„¹ï¸  No hay versiÃ³n stable previa para hacer backup (primer despliegue)"
          fi

      - name: ğŸš€ Promover Canary a ProducciÃ³n y actualizar GHCR
        run: |
          cd ServiCiudadCali
          VERSION=${{ needs.build-and-test.outputs.version }}
          IMAGE_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          
          # Detener contenedores locales
          docker compose stop app-stable 2>/dev/null || true
          docker compose rm -f app-stable 2>/dev/null || true
          docker compose --profile canary stop app-canary 2>/dev/null || true
          docker compose --profile canary rm -f app-canary 2>/dev/null || true
          
          # Promover: la imagen canary (nueva) se convierte en stable
          docker tag serviciudadcali:canary serviciudadcali:stable
          
          # IMPORTANTE: Subir la nueva stable a GHCR
          docker tag serviciudadcali:canary ${IMAGE_BASE}:stable
          docker push ${IMAGE_BASE}:stable
          
          echo "ğŸ”„ PromociÃ³n: Canary (v${VERSION}) â†’ Stable"
          echo "âœ… Nueva versiÃ³n STABLE subida a GHCR: ${IMAGE_BASE}:stable"
          
          # Desplegar NUEVA versiÃ³n como stable en producciÃ³n
          VERSION=$VERSION docker compose up -d app-stable
          
          echo "âœ… Nueva versiÃ³n promovida a STABLE en puerto 8080"
          echo "ğŸ”— URL ProducciÃ³n: http://localhost:8080"

      - name: â³ Esperar inicializaciÃ³n
        run: sleep 30

      - name: ğŸ” Health Check ProducciÃ³n
        run: |
          echo "ğŸ” Verificando health de versiÃ³n en producciÃ³n..."
          
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              echo "âœ… ProducciÃ³n estÃ¡ saludable!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Intento $RETRY_COUNT/$MAX_RETRIES - Reintentando en 5 segundos..."
            sleep 5
          done
          
          echo "âŒ Health check de producciÃ³n fallÃ³"
          echo "ğŸ”„ Iniciando rollback automÃ¡tico..."
          exit 1

      - name: ğŸ§¹ Limpiar Canary
        if: success()
        run: |
          cd ServiCiudadCali
          docker compose --profile canary stop app-canary 2>/dev/null || true
          docker compose --profile canary rm -f app-canary 2>/dev/null || true
          echo "âœ… VersiÃ³n Canary removida"

      - name: ğŸ‰ Despliegue completado
        if: success()
        run: |
          echo "ğŸ‰ Â¡Despliegue a producciÃ³n completado exitosamente!"
          echo "ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ“Š Cobertura: ${{ needs.build-and-test.outputs.coverage }}%"
          echo "ğŸ”— URL: http://localhost:8080"

  # ==============================================================
  # JOB 5: Rollback AutomÃ¡tico (en caso de fallo)
  # ==============================================================
  rollback:
    name: Rollback AutomÃ¡tico
    needs: [promote-to-production]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Login a GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Ejecutar Rollback con Docker Compose
        run: |
          cd ServiCiudadCali
          IMAGE_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          
          echo "ğŸ”„ Iniciando rollback a versiÃ³n anterior..."
          
          # Descargar imagen de rollback desde GHCR
          if docker pull ${IMAGE_BASE}:rollback 2>/dev/null; then
            echo "âœ… Imagen de rollback descargada de GHCR"
            
            # Detener versiÃ³n fallida
            docker compose stop app-stable 2>/dev/null || true
            docker compose rm -f app-stable 2>/dev/null || true
            
            # Restaurar imagen de rollback como stable (local y en GHCR)
            docker tag ${IMAGE_BASE}:rollback serviciudadcali:stable
            docker tag ${IMAGE_BASE}:rollback ${IMAGE_BASE}:stable
            docker push ${IMAGE_BASE}:stable
            
            # Desplegar versiÃ³n anterior con Docker Compose
            docker compose up -d app-stable
            
            echo "âœ… Rollback completado - VersiÃ³n anterior restaurada como STABLE"
            echo "âœ… Imagen stable actualizada en GHCR"
          else
            echo "âŒ ERROR: No se encontrÃ³ imagen de rollback en GHCR"
            echo "âš ï¸  No se puede hacer rollback automÃ¡tico"
            exit 1
          fi

      - name: ğŸ“§ Notificar fallo
        run: |
          echo "âŒ ALERTA: Despliegue fallÃ³ - Rollback ejecutado"
          echo "ğŸ“‹ Revisar logs para mÃ¡s detalles"
