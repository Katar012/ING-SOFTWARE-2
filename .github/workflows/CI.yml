name: CI/CD con Canary Deploy

on:
  push:
    branches: ["Vila"]
  pull_request:
    branches: ["Vila"]

env:
  COVERAGE_THRESHOLD: 80
  STABLE_IMAGE_NAME: serviciudadcali-stable

jobs:
  # ==============================================================
  # JOB 1: Build, Test y VerificaciÃ³n de Cobertura
  # ==============================================================
  build-and-test:
    name: ğŸ—ï¸ Build y Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: acueducto
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: â³ Esperar a que MySQL estÃ© listo
        run: |
          for i in {1..30}; do
            nc -z localhost 3306 && echo "âœ… MySQL estÃ¡ listo" && break
            sleep 2
          done

      - name: ğŸ”¢ Generar versiÃ³n semÃ¡ntica
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ VersiÃ³n generada: $VERSION"

      - name: ğŸ—ï¸ Compilar proyecto
        run: |
          cd ServiCiudadCali
          mvn -B clean compile
          echo "âœ… CompilaciÃ³n exitosa"

      - name: ğŸ§ª Ejecutar pruebas unitarias
        run: |
          cd ServiCiudadCali
          mvn test

      - name: ğŸ“Š Verificar umbral de cobertura (â‰¥80%)
        id: coverage
        run: |
          cd ServiCiudadCali
          
          if ! mvn verify; then
            echo "âŒ ERROR: Cobertura menor al 80%"
            exit 1
          fi
          
          echo "âœ… Cobertura cumple con el umbral requerido"

      - name: ğŸ“Š Generar reporte de cobertura JaCoCo
        if: always()
        run: |
          cd ServiCiudadCali
          mvn jacoco:report

      - name: ğŸ“¤ Subir reporte de cobertura
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: ServiCiudadCali/target/site/jacoco/
          retention-days: 30

      - name: ğŸ“¦ Empaquetar aplicaciÃ³n
        run: |
          cd ServiCiudadCali
          mvn -B package -DskipTests
          echo "âœ… JAR generado"

      - name: ğŸ“¤ Subir artefacto JAR
        uses: actions/upload-artifact@v4
        with:
          name: serviciudadcali-${{ steps.version.outputs.version }}.jar
          path: ServiCiudadCali/target/*.jar
          retention-days: 5

  # ==============================================================
  # JOB 2: Despliegue Canary (ValidaciÃ³n Local)
  # ==============================================================
  canary-validation:
    name: ğŸ•¯ï¸ ValidaciÃ³n Canary
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/Vila'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: acueducto
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar JAR
        uses: actions/download-artifact@v4
        with:
          name: serviciudadcali-${{ needs.build-and-test.outputs.version }}.jar
          path: ServiCiudadCali/target/

      # ============================================================
      # DESCARGAR STABLE ANTERIOR
      # ============================================================
      - name: ğŸ“¥ Descargar artefacto STABLE del workflow anterior
        id: download-stable
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Buscando Ãºltimo artefacto STABLE..."
          echo "ğŸ“¦ Nombre: ${{ env.STABLE_IMAGE_NAME }}"
          echo ""
          
          # Buscar artefactos (excluyendo el workflow actual)
          ARTIFACT_JSON=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/artifacts?name=${{ env.STABLE_IMAGE_NAME }}&per_page=10" 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "âŒ Error consultando API de GitHub"
            echo "$ARTIFACT_JSON"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Filtrar artefactos del workflow actual y obtener el mÃ¡s reciente
          ARTIFACT_ID=$(echo "$ARTIFACT_JSON" | jq -r --arg RUN_ID "${{ github.run_id }}" \
            '.artifacts[] | select(.workflow_run.id != ($RUN_ID | tonumber)) | .id' | head -n1)
          
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" == "null" ]; then
            echo "â„¹ï¸  No hay artefacto STABLE de workflows anteriores"
            echo "â„¹ï¸  Este serÃ¡ el primer despliegue"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Obtener informaciÃ³n del artefacto
          ARTIFACT_SIZE=$(echo "$ARTIFACT_JSON" | jq -r --arg ID "$ARTIFACT_ID" \
            '.artifacts[] | select(.id == ($ID | tonumber)) | .size_in_bytes')
          ARTIFACT_RUN=$(echo "$ARTIFACT_JSON" | jq -r --arg ID "$ARTIFACT_ID" \
            '.artifacts[] | select(.id == ($ID | tonumber)) | .workflow_run.id')
          ARTIFACT_CREATED=$(echo "$ARTIFACT_JSON" | jq -r --arg ID "$ARTIFACT_ID" \
            '.artifacts[] | select(.id == ($ID | tonumber)) | .created_at')
          
          echo "âœ… Artefacto encontrado"
          echo "  - ID: $ARTIFACT_ID"
          echo "  - TamaÃ±o: $(awk "BEGIN {printf \"%.1f MB\", $ARTIFACT_SIZE/1048576}")"
          echo "  - Workflow Run: $ARTIFACT_RUN"
          echo "  - Creado: $ARTIFACT_CREATED"
          echo ""
          
          # Descargar artefacto
          echo "ğŸ“¥ Descargando artefacto..."
          mkdir -p ./stable-image/
          
          if ! gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
            > ./stable-image/artifact.zip; then
            echo "âŒ Error descargando artefacto"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Descomprimir
          echo "ğŸ“¦ Descomprimiendo..."
          cd ./stable-image/
          unzip -q artifact.zip
          rm artifact.zip
          cd ..
          
          # Verificar contenido
          if [ -f "./stable-image/serviciudadcali-stable.tar.gz" ]; then
            FILE_SIZE=$(du -h ./stable-image/serviciudadcali-stable.tar.gz | cut -f1)
            echo ""
            echo "âœ… Artefacto descargado exitosamente"
            echo "ğŸ“¦ Archivo: serviciudadcali-stable.tar.gz"
            echo "ğŸ“ TamaÃ±o descomprimido: $FILE_SIZE"
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Archivo tar.gz no encontrado en el artefacto"
            echo "ğŸ“‚ Contenido del artefacto:"
            ls -la ./stable-image/
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Verificar si hay versiÃ³n STABLE previa
        id: check-stable
        run: |
          if [ "${{ steps.download-stable.outputs.found }}" == "true" ]; then
            echo "has_stable=true" >> $GITHUB_OUTPUT
            echo "âœ… Se encontrÃ³ versiÃ³n STABLE anterior"
          else
            echo "has_stable=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No hay versiÃ³n STABLE anterior (primer despliegue)"
          fi

      # ============================================================
      # CASO 1: HAY VERSIÃ“N STABLE ANTERIOR â†’ Despliegue Canary Real
      # ============================================================
      - name: ğŸ”„ Restaurar imagen STABLE anterior
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ”„ Cargando imagen STABLE anterior..."
          docker load < ./stable-image/serviciudadcali-stable.tar.gz
          echo "âœ… Imagen STABLE anterior restaurada"
          echo ""
          echo "ğŸ“Š ImÃ¡genes disponibles:"
          docker images | grep serviciudadcali

      - name: ğŸ³ Build imagen CANARY (nueva versiÃ³n)
        run: |
          echo "ğŸ³ Construyendo imagen CANARY con cÃ³digo nuevo..."
          cd ServiCiudadCali
          
          # Renombrar JAR para Dockerfile
          mv target/serviciudadcali-*.jar target/ServiCiudadCali-0.0.1-SNAPSHOT.jar 2>/dev/null || true
          
          # Build desde raÃ­z
          cd ..
          docker build -t serviciudadcali:canary \
            -f ServiCiudadCali/Dockerfile .
          
          echo "âœ… Imagen CANARY construida"
          echo ""
          echo "ğŸ“Š Imagen CANARY:"
          docker images | grep canary

      - name: ğŸš€ Levantar STABLE y CANARY en paralelo
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "=========================================="
          echo "âœ… DESPLIEGUE CANARY CON DOS VERSIONES"
          echo "=========================================="
          echo ""
          
          # Esperar a que MySQL estÃ© listo
          echo "â³ Esperando MySQL..."
          sleep 10
          
          # Levantar STABLE (versiÃ³n ANTERIOR) en puerto 8080
          echo "ğŸš€ Desplegando STABLE en puerto 8080..."
          docker run -d \
            --name serviciudadcali-stable \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8080 \
            serviciudadcali:stable
          
          echo "âœ… STABLE desplegado en puerto 8080 (versiÃ³n ANTERIOR)"
          
          # Esperar que STABLE inicie
          echo "â³ Esperando que STABLE inicie (20s)..."
          sleep 20
          
          # Levantar CANARY (versiÃ³n NUEVA) en puerto 8081
          echo "ğŸš€ Desplegando CANARY en puerto 8081..."
          docker run -d \
            --name serviciudadcali-canary \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8081 \
            serviciudadcali:canary
          
          echo "âœ… CANARY desplegado en puerto 8081 (versiÃ³n NUEVA)"
          echo ""
          echo "ğŸ“Š Estado de contenedores:"
          docker ps
          echo ""
          echo "ğŸ”— Puerto 8080: STABLE (versiÃ³n anterior - workflow previo)"
          echo "ğŸ”— Puerto 8081: CANARY (versiÃ³n nueva - commit ${{ github.sha }})"

      # ============================================================
      # CASO 2: NO HAY STABLE ANTERIOR â†’ Primer Despliegue
      # ============================================================
      - name: ğŸš€ Primer despliegue (sin Canary)
        if: steps.check-stable.outputs.has_stable == 'false'
        run: |
          echo "=========================================="
          echo "â„¹ï¸  PRIMER DESPLIEGUE - NO HAY CANARY"
          echo "=========================================="
          echo ""
          
          # Verificar MySQL
          echo "ğŸ” Verificando MySQL..."
          for i in {1..30}; do
            if docker ps | grep mysql:8.0 > /dev/null && \
               docker exec $(docker ps -q -f ancestor=mysql:8.0) mysqladmin ping -h localhost -proot --silent 2>/dev/null; then
              echo "âœ… MySQL estÃ¡ listo"
              break
            fi
            echo "â³ Esperando MySQL... intento $i/30"
            sleep 2
          done
          
          # Tagear imagen como stable
          docker tag serviciudadcali:canary serviciudadcali:stable
          
          # Desplegar
          echo "ğŸš€ Desplegando primera versiÃ³n como STABLE..."
          docker run -d \
            --name serviciudadcali-stable \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8080 \
            serviciudadcali:stable
          
          echo "âœ… Primera versiÃ³n desplegada como STABLE en puerto 8080"
          echo "â„¹ï¸  En el prÃ³ximo push, esta serÃ¡ la versiÃ³n 'vieja' y habrÃ¡ Canary"
          echo ""
          echo "ğŸ“Š Contenedores:"
          docker ps
          
          # Esperar inicializaciÃ³n
          echo ""
          echo "â³ Esperando 60s para que Spring Boot inicie..."
          sleep 60
          
          echo ""
          echo "ğŸ“ Primeros logs:"
          docker logs --tail 50 serviciudadcali-stable

      # ============================================================
      # Health Checks
      # ============================================================
      - name: â³ Esperar inicializaciÃ³n adicional
        run: |
          echo "â³ Esperando 15 segundos adicionales..."
          sleep 15

      - name: ğŸ” Health Check - STABLE
        if: always()
        run: |
          echo "ğŸ” Verificando STABLE en puerto 8080..."
          echo ""
          
          # Verificar contenedor
          if ! docker ps | grep serviciudadcali-stable; then
            echo "âŒ ERROR: Contenedor STABLE no estÃ¡ corriendo"
            docker ps -a | grep serviciudadcali-stable || true
            echo ""
            docker logs serviciudadcali-stable || true
            exit 1
          fi
          
          echo "âœ… Contenedor STABLE corriendo"
          echo ""
          
          # Health checks
          MAX_RETRIES=20
          for i in $(seq 1 $MAX_RETRIES); do
            echo "â³ Intento $i/$MAX_RETRIES..."
            
            if curl -f http://localhost:8080/actuator/health 2>&1 | tee /tmp/stable-health.log | grep -q "UP"; then
              echo ""
              echo "âœ… STABLE estÃ¡ saludable"
              curl http://localhost:8080/actuator/health | jq '.' 2>/dev/null || cat
              break
            fi
            
            if grep -q "Connection refused" /tmp/stable-health.log; then
              echo "âš ï¸  ConexiÃ³n rechazada - Spring Boot iniciando..."
            fi
            
            # Logs cada 5 intentos
            if [ $((i % 5)) -eq 0 ]; then
              echo ""
              echo "ğŸ“ Ãšltimos 20 logs:"
              docker logs --tail 20 serviciudadcali-stable
              echo ""
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo ""
              echo "âŒ STABLE no respondiÃ³ despuÃ©s de $MAX_RETRIES intentos"
              echo ""
              echo "ğŸ“ Logs completos:"
              docker logs serviciudadcali-stable
              exit 1
            fi
            
            sleep 5
          done

      - name: ğŸ” Health Check - CANARY
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ” Verificando CANARY en puerto 8081..."
          echo ""
          
          MAX_RETRIES=15
          for i in $(seq 1 $MAX_RETRIES); do
            echo "â³ Intento $i/$MAX_RETRIES..."
            
            if curl -f http://localhost:8081/actuator/health 2>&1 | grep -q "UP"; then
              echo ""
              echo "âœ… CANARY estÃ¡ saludable"
              curl http://localhost:8081/actuator/health | jq '.' 2>/dev/null || cat
              break
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo ""
              echo "âŒ CANARY no respondiÃ³"
              echo ""
              docker logs serviciudadcali-canary
              exit 1
            fi
            
            echo "âš ï¸  No disponible, reintentando en 5s..."
            sleep 5
          done

      # ============================================================
      # Tests y ComparaciÃ³n
      # ============================================================
      - name: ğŸ§ª Smoke Tests en CANARY
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ§ª Smoke tests en CANARY..."
          
          echo "ğŸ“ Test: GET /actuator/health"
          curl -f http://localhost:8081/actuator/health || exit 1
          
          echo ""
          echo "âœ… Smoke tests completados"

      - name: ğŸ“Š Comparar STABLE vs CANARY
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ“Š Comparando versiones..."
          echo ""
          echo "STABLE (8080):"
          curl -s http://localhost:8080/actuator/health | jq '.' 2>/dev/null || curl -s http://localhost:8080/actuator/health
          echo ""
          echo "CANARY (8081):"
          curl -s http://localhost:8081/actuator/health | jq '.' 2>/dev/null || curl -s http://localhost:8081/actuator/health

      - name: ğŸ“ Logs finales
        if: always()
        run: |
          echo "ğŸ“ Logs STABLE:"
          docker logs --tail 50 serviciudadcali-stable 2>&1 || true
          
          if docker ps | grep serviciudadcali-canary; then
            echo ""
            echo "ğŸ“ Logs CANARY:"
            docker logs --tail 50 serviciudadcali-canary 2>&1 || true
          fi

      # ============================================================
      # Guardar imagen para prÃ³ximo workflow
      # ============================================================
      - name: ğŸ’¾ Guardar imagen CANARY como STABLE
        if: success()
        run: |
          echo "ğŸ’¾ Guardando imagen CANARY como STABLE para prÃ³ximo workflow..."
          
          docker tag serviciudadcali:canary serviciudadcali:stable
          
          mkdir -p stable-image-new
          docker save serviciudadcali:stable | gzip > stable-image-new/serviciudadcali-stable.tar.gz
          
          FILE_SIZE=$(du -h stable-image-new/serviciudadcali-stable.tar.gz | cut -f1)
          echo "âœ… Imagen guardada (tamaÃ±o: $FILE_SIZE)"

      - name: ğŸ“¤ Subir artefacto STABLE
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.STABLE_IMAGE_NAME }}
          path: stable-image-new/serviciudadcali-stable.tar.gz
          retention-days: 30
          overwrite: true

      - name: ğŸ“‹ Resumen
        if: success()
        run: |
          if [ "${{ steps.check-stable.outputs.has_stable }}" == "true" ]; then
            echo "=========================================="
            echo "âœ… VALIDACIÃ“N CANARY EXITOSA"
            echo "=========================================="
            echo "ğŸ”— STABLE (anterior): localhost:8080 âœ…"
            echo "ğŸ”— CANARY (nueva): localhost:8081 âœ…"
            echo ""
            echo "âœ… CANARY pasÃ³ todos los tests"
            echo "ğŸš€ Listo para producciÃ³n"
          else
            echo "=========================================="
            echo "âœ… PRIMER DESPLIEGUE EXITOSO"
            echo "=========================================="
            echo "ğŸ”— STABLE: localhost:8080 âœ…"
            echo ""
            echo "â„¹ï¸  PrÃ³ximo push: Canary Deploy"
          fi

  # ==============================================================
  # JOB 3: Deploy a Render
  # ==============================================================
  deploy-to-render:
    name: ğŸš€ Deploy a ProducciÃ³n
    needs: [build-and-test, canary-validation]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/Vila'
    
    steps:
      - name: ğŸ” Verificar webhook
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "âŒ RENDER_DEPLOY_HOOK_URL no configurado"
            exit 1
          fi
          echo "âœ… Webhook configurado"

      - name: ğŸš€ Trigger deploy
        run: |
          echo "ğŸš€ Desplegando a Render..."
          echo "ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
          echo ""
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")
          
          echo "ğŸ“Š CÃ³digo HTTP: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "âœ… Deploy iniciado"
          else
            echo "âŒ Error (cÃ³digo: $HTTP_CODE)"
            exit 1
          fi

      - name: â³ Esperar deploy
        run: |
          echo "â³ Esperando 3 minutos..."
          sleep 180

      - name: ğŸ” Verificar deploy
        continue-on-error: true
        run: |
          echo "ğŸ” Verificando Render..."
          
          for i in {1..10}; do
            if curl -f https://serviciudadcali.onrender.com/actuator/health 2>/dev/null; then
              echo "âœ… AplicaciÃ³n disponible"
              exit 0
            fi
            echo "â³ Intento $i/10..."
            sleep 15
          done
          
          echo "âš ï¸  VerificaciÃ³n timeout (normal en plan gratuito)"

      - name: ğŸ‰ Completado
        run: |
          echo "=========================================="
          echo "ğŸ‰ PIPELINE COMPLETADO"
          echo "=========================================="
          echo "ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
          echo "ğŸŒ URL: https://serviciudadcali.onrender.com"