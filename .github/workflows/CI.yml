name: CI/CD con Canary Deploy

on:
  push:
    branches: ["Vila"]
  pull_request:
    branches: ["Vila"]

env:
  COVERAGE_THRESHOLD: 80
  STABLE_IMAGE_NAME: serviciudadcali-stable

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build y Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: acueducto
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: â³ Esperar a que MySQL estÃ© listo
        run: |
          for i in {1..30}; do
            nc -z localhost 3306 && echo "âœ… MySQL estÃ¡ listo" && break
            sleep 2
          done

      - name: ğŸ”¢ Generar versiÃ³n semÃ¡ntica
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ VersiÃ³n generada: $VERSION"

      - name: ğŸ—ï¸ Compilar proyecto
        run: |
          cd ServiCiudadCali
          mvn -B clean compile
          echo "âœ… CompilaciÃ³n exitosa"

      - name: ğŸ§ª Ejecutar pruebas unitarias
        run: |
          cd ServiCiudadCali
          mvn test

      - name: ğŸ“Š Verificar umbral de cobertura (â‰¥80%)
        id: coverage
        run: |
          cd ServiCiudadCali
          
          if ! mvn verify; then
            echo "âŒ ERROR: Cobertura menor al 80%"
            exit 1
          fi
          
          echo "âœ… Cobertura cumple con el umbral requerido"

      - name: ğŸ“Š Generar reporte de cobertura JaCoCo
        if: always()
        run: |
          cd ServiCiudadCali
          mvn jacoco:report

      - name: ğŸ“¤ Subir reporte de cobertura
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: ServiCiudadCali/target/site/jacoco/
          retention-days: 30

      - name: ğŸ“¦ Empaquetar aplicaciÃ³n
        run: |
          cd ServiCiudadCali
          mvn -B package -DskipTests
          echo "âœ… JAR generado"

      - name: ğŸ“¤ Subir artefacto JAR
        uses: actions/upload-artifact@v4
        with:
          name: serviciudadcali-${{ steps.version.outputs.version }}.jar
          path: ServiCiudadCali/target/*.jar
          retention-days: 5

  canary-validation:
    name: ğŸ•¯ï¸ ValidaciÃ³n Canary
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/Vila'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: acueducto
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar JAR
        uses: actions/download-artifact@v4
        with:
          name: serviciudadcali-${{ needs.build-and-test.outputs.version }}.jar
          path: ServiCiudadCali/target/

      - name: ğŸ“¥ Descargar artefacto STABLE del workflow anterior
        id: download-stable
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Buscando Ãºltimo artefacto STABLE..."
          echo "ğŸ“¦ Nombre: ${{ env.STABLE_IMAGE_NAME }}"
          
          ARTIFACT_JSON=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/artifacts?name=${{ env.STABLE_IMAGE_NAME }}&per_page=10" 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "âŒ Error consultando API"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          ARTIFACT_ID=$(echo "$ARTIFACT_JSON" | jq -r --arg RUN_ID "${{ github.run_id }}" \
            '.artifacts[] | select(.workflow_run.id != ($RUN_ID | tonumber)) | .id' | head -n1)
          
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" == "null" ]; then
            echo "â„¹ï¸  No hay artefacto STABLE anterior"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Artefacto encontrado (ID: $ARTIFACT_ID)"
          
          mkdir -p ./stable-image/
          
          if ! gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
            > ./stable-image/artifact.zip; then
            echo "âŒ Error descargando"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          cd ./stable-image/
          unzip -q artifact.zip
          rm artifact.zip
          cd ..
          
          if [ -f "./stable-image/serviciudadcali-stable.tar.gz" ]; then
            echo "âœ… Artefacto descargado exitosamente"
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Archivo tar.gz no encontrado"
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Verificar si hay versiÃ³n STABLE previa
        id: check-stable
        run: |
          if [ "${{ steps.download-stable.outputs.found }}" == "true" ]; then
            echo "has_stable=true" >> $GITHUB_OUTPUT
            echo "âœ… Se encontrÃ³ versiÃ³n STABLE anterior"
          else
            echo "has_stable=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No hay versiÃ³n STABLE anterior (primer despliegue)"
          fi

      - name: ğŸ”„ Restaurar imagen STABLE anterior
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ”„ Cargando imagen STABLE anterior..."
          docker load < ./stable-image/serviciudadcali-stable.tar.gz
          echo "âœ… Imagen STABLE anterior restaurada"

      - name: ğŸ³ Build imagen CANARY (nueva versiÃ³n)
        run: |
          echo "ğŸ³ Construyendo imagen CANARY..."
          cd ServiCiudadCali
          mv target/serviciudadcali-*.jar target/ServiCiudadCali-0.0.1-SNAPSHOT.jar 2>/dev/null || true
          cd ..
          docker build -t serviciudadcali:canary -f ServiCiudadCali/Dockerfile .
          echo "âœ… Imagen CANARY construida"

      - name: ğŸš€ Levantar STABLE y CANARY en paralelo
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "=========================================="
          echo "âœ… DESPLIEGUE CANARY CON DOS VERSIONES"
          echo "=========================================="
          
          sleep 10
          
          docker run -d \
            --name serviciudadcali-stable \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8080 \
            serviciudadcali:stable
          
          echo "âœ… STABLE en puerto 8080"
          sleep 20
          
          docker run -d \
            --name serviciudadcali-canary \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8081 \
            serviciudadcali:canary
          
          echo "âœ… CANARY en puerto 8081"

      - name: ğŸš€ Primer despliegue (sin Canary)
        if: steps.check-stable.outputs.has_stable == 'false'
        run: |
          echo "=========================================="
          echo "â„¹ï¸  PRIMER DESPLIEGUE"
          echo "=========================================="
          
          sleep 10
          docker tag serviciudadcali:canary serviciudadcali:stable
          
          docker run -d \
            --name serviciudadcali-stable \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8080 \
            serviciudadcali:stable
          
          echo "âœ… STABLE en puerto 8080"
          sleep 60

      - name: ğŸ” Health Check - STABLE
        run: |
          echo "ğŸ” Verificando STABLE..."
          
          for i in {1..20}; do
            if curl -f http://localhost:8080/actuator/health 2>&1 | grep -q "UP"; then
              echo "âœ… STABLE OK"
              break
            fi
            [ $i -eq 20 ] && exit 1
            sleep 5
          done

      - name: ğŸ” Health Check - CANARY
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ” Verificando CANARY..."
          
          for i in {1..15}; do
            if curl -f http://localhost:8081/actuator/health 2>&1 | grep -q "UP"; then
              echo "âœ… CANARY OK"
              break
            fi
            [ $i -eq 15 ] && exit 1
            sleep 5
          done

      - name: ğŸ’¾ Guardar imagen CANARY como STABLE
        if: success()
        run: |
          docker tag serviciudadcali:canary serviciudadcali:stable
          mkdir -p stable-image-new
          docker save serviciudadcali:stable | gzip > stable-image-new/serviciudadcali-stable.tar.gz
          echo "âœ… Imagen guardada"

      - name: ğŸ“¤ Subir artefacto STABLE
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.STABLE_IMAGE_NAME }}
          path: stable-image-new/serviciudadcali-stable.tar.gz
          retention-days: 30
          overwrite: true

  deploy-to-render:
    name: ğŸš€ Deploy a ProducciÃ³n
    needs: [build-and-test, canary-validation]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/Vila'
    
    steps:
      - name: ğŸš€ Trigger deploy
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")
          echo "ğŸ“Š CÃ³digo: $HTTP_CODE"
          [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "204" ] || exit 1

      - name: â³ Esperar
        run: sleep 180

      - name: ğŸ” Verificar
        continue-on-error: true
        run: |
          for i in {1..10}; do
            curl -f https://serviciudadcali.onrender.com/actuator/health && exit 0
            sleep 15
          done