name: CI/CD con Canary Deploy

on:
  push:
    branches: ["Vila"]
  pull_request:
    branches: ["Vila"]

env:
  COVERAGE_THRESHOLD: 80
  STABLE_IMAGE_NAME: serviciudadcali-stable-persistent

jobs:
  # ==============================================================
  # JOB 1: Build, Test y VerificaciÃ³n de Cobertura
  # ==============================================================
  build-and-test:
    name: ğŸ—ï¸ Build y Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: acueducto
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: â³ Esperar a que MySQL estÃ© listo
        run: |
          for i in {1..30}; do
            nc -z localhost 3306 && echo "âœ… MySQL estÃ¡ listo" && break
            sleep 2
          done

      - name: ğŸ”¢ Generar versiÃ³n semÃ¡ntica
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ VersiÃ³n generada: $VERSION"

      - name: ğŸ—ï¸ Compilar proyecto
        run: |
          cd ServiCiudadCali
          mvn -B clean compile
          echo "âœ… CompilaciÃ³n exitosa"

      - name: ğŸ§ª Ejecutar pruebas unitarias
        run: |
          cd ServiCiudadCali
          mvn test

      - name: ğŸ“Š Verificar umbral de cobertura (â‰¥80%)
        id: coverage
        run: |
          cd ServiCiudadCali
          
          # Verificar con mvn verify (incluye jacoco:check)
          if ! mvn verify; then
            echo "âŒ ERROR: Cobertura menor al 80%"
            exit 1
          fi
          
          echo "âœ… Cobertura cumple con el umbral requerido"

      - name: ğŸ“Š Generar reporte de cobertura JaCoCo
        if: always()
        run: |
          cd ServiCiudadCali
          mvn jacoco:report

      - name: ğŸ“¤ Subir reporte de cobertura
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: ServiCiudadCali/target/site/jacoco/
          retention-days: 30

      - name: ğŸ“¦ Empaquetar aplicaciÃ³n
        run: |
          cd ServiCiudadCali
          mvn -B package -DskipTests
          echo "âœ… JAR generado"

      - name: ğŸ“¤ Subir artefacto JAR
        uses: actions/upload-artifact@v4
        with:
          name: serviciudadcali-${{ steps.version.outputs.version }}.jar
          path: ServiCiudadCali/target/*.jar
          retention-days: 5

  # ==============================================================
  # JOB 2: Despliegue Canary (ValidaciÃ³n Local)
  # ==============================================================
  canary-validation:
    name: ğŸ•¯ï¸ ValidaciÃ³n Canary
    needs: build-and-test
    runs-on: ubuntu-latest
    # CAMBIO AQUÃ: Usar rama Vila en lugar de main
    if: github.event_name == 'push' && github.ref == 'refs/heads/Vila'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: acueducto
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar JAR
        uses: actions/download-artifact@v4
        with:
          name: serviciudadcali-${{ needs.build-and-test.outputs.version }}.jar
          path: ServiCiudadCali/target/

      # ============================================================
      # CLAVE: Descargar versiÃ³n STABLE anterior (si existe)
      # ============================================================
      - name: ğŸ“¥ Intentar descargar imagen STABLE anterior
        id: download-stable
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ${{ env.STABLE_IMAGE_NAME }}
          path: ./stable-image/

      - name: ğŸ” Verificar si hay versiÃ³n STABLE previa
        id: check-stable
        run: |
          if [ -f "./stable-image/serviciudadcali-stable.tar.gz" ]; then
            echo "has_stable=true" >> $GITHUB_OUTPUT
            echo "âœ… Se encontrÃ³ versiÃ³n STABLE anterior"
          else
            echo "has_stable=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No hay versiÃ³n STABLE anterior (primer despliegue)"
          fi

      # ============================================================
      # CASO 1: HAY VERSIÃ“N STABLE ANTERIOR â†’ Despliegue Canary Real
      # ============================================================
      - name: ğŸ”„ Restaurar imagen STABLE anterior
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          cd stable-image
          docker load < serviciudadcali-stable.tar.gz
          echo "âœ… Imagen STABLE anterior restaurada"
          docker images | grep serviciudadcali

      - name: ğŸ³ Build imagen CANARY (nueva versiÃ³n)
        run: |
          cd ServiCiudadCali
          
          # Renombrar JAR para que coincida con Dockerfile
          mv target/serviciudadcali-*.jar target/ServiCiudadCali-0.0.1-SNAPSHOT.jar || true
          
          # Build desde raÃ­z (como en tu CI actual)
          cd ..
          docker build -t serviciudadcali:canary \
            -f ServiCiudadCali/Dockerfile .
          
          echo "âœ… Imagen CANARY construida con cÃ³digo nuevo"

      - name: ğŸš€ Levantar STABLE y CANARY en paralelo
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "=========================================="
          echo "âœ… DESPLIEGUE CANARY CON DOS VERSIONES"
          echo "=========================================="
          
          # Esperar a que MySQL estÃ© listo
          sleep 10
          
          # Levantar STABLE (versiÃ³n ANTERIOR) en puerto 8080
          docker run -d \
            --name serviciudadcali-stable \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8080 \
            serviciudadcali:stable
          
          echo "âœ… STABLE desplegado en puerto 8080 (versiÃ³n ANTERIOR)"
          
          # Esperar inicializaciÃ³n de stable
          sleep 20
          
          # Levantar CANARY (versiÃ³n NUEVA) en puerto 8081
          docker run -d \
            --name serviciudadcali-canary \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8081 \
            serviciudadcali:canary
          
          echo "âœ… CANARY desplegado en puerto 8081 (versiÃ³n NUEVA)"
          
          # Mostrar estado
          docker ps
          echo ""
          echo "ğŸ”— Puerto 8080: STABLE (versiÃ³n anterior)"
          echo "ğŸ”— Puerto 8081: CANARY (versiÃ³n nueva - commit actual)"

      # ============================================================
      # CASO 2: NO HAY STABLE ANTERIOR â†’ Primer Despliegue
      # ============================================================
      - name: ğŸš€ Primer despliegue (sin Canary)
        if: steps.check-stable.outputs.has_stable == 'false'
        run: |
          echo "=========================================="
          echo "â„¹ï¸  PRIMER DESPLIEGUE - NO HAY CANARY"
          echo "=========================================="
          
          # Esperar a que MySQL estÃ© listo
          sleep 10
          
          # La imagen nueva se convierte en STABLE
          docker tag serviciudadcali:canary serviciudadcali:stable
          
          # Desplegar como STABLE en puerto 8080
          docker run -d \
            --name serviciudadcali-stable \
            --network host \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/acueducto \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e SERVER_PORT=8080 \
            serviciudadcali:stable
          
          echo "âœ… Primera versiÃ³n desplegada como STABLE en puerto 8080"
          echo "â„¹ï¸  En el prÃ³ximo push, esta serÃ¡ la versiÃ³n 'vieja'"
          
          docker ps

      # ============================================================
      # Esperar inicializaciÃ³n
      # ============================================================
      - name: â³ Esperar inicializaciÃ³n de servicios
        run: |
          echo "â³ Esperando 30 segundos para que Spring Boot inicie..."
          sleep 30

      # ============================================================
      # Health Checks
      # ============================================================
      - name: ğŸ” Health Check - STABLE
        if: always()
        run: |
          echo "ğŸ” Verificando STABLE en puerto 8080..."
          
          MAX_RETRIES=15
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              echo "âœ… STABLE estÃ¡ saludable"
              curl http://localhost:8080/actuator/health
              break
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo "âŒ STABLE no respondiÃ³ despuÃ©s de $MAX_RETRIES intentos"
              docker logs serviciudadcali-stable
              exit 1
            fi
            
            echo "â³ Intento $i/$MAX_RETRIES - Reintentando en 5s..."
            sleep 5
          done

      - name: ğŸ” Health Check - CANARY
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ” Verificando CANARY en puerto 8081..."
          
          MAX_RETRIES=15
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f http://localhost:8081/actuator/health 2>/dev/null; then
              echo "âœ… CANARY estÃ¡ saludable"
              curl http://localhost:8081/actuator/health
              break
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo "âŒ CANARY no respondiÃ³ despuÃ©s de $MAX_RETRIES intentos"
              docker logs serviciudadcali-canary
              exit 1
            fi
            
            echo "â³ Intento $i/$MAX_RETRIES - Reintentando en 5s..."
            sleep 5
          done

      # ============================================================
      # Smoke Tests en CANARY (versiÃ³n nueva)
      # ============================================================
      - name: ğŸ§ª Smoke Tests en CANARY
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ§ª Ejecutando smoke tests en CANARY (puerto 8081)..."
          
          # Test 1: Health endpoint
          echo "ğŸ“ Test 1: GET /actuator/health"
          curl -f http://localhost:8081/actuator/health || exit 1
          
          # Test 2: Endpoint raÃ­z (si existe)
          echo "ğŸ“ Test 2: GET /"
          curl -f http://localhost:8081/ || echo "âš ï¸  Endpoint raÃ­z no disponible (ok)"
          
          echo "âœ… Smoke tests completados exitosamente"

      # ============================================================
      # Comparar respuestas STABLE vs CANARY
      # ============================================================
      - name: ğŸ“Š Comparar STABLE vs CANARY
        if: steps.check-stable.outputs.has_stable == 'true'
        run: |
          echo "ğŸ“Š Comparando respuestas de STABLE vs CANARY..."
          
          echo "STABLE (puerto 8080):"
          curl -s http://localhost:8080/actuator/health | jq '.' || true
          
          echo ""
          echo "CANARY (puerto 8081):"
          curl -s http://localhost:8081/actuator/health | jq '.' || true

      # ============================================================
      # Mostrar logs
      # ============================================================
      - name: ğŸ“ Logs de contenedores
        if: always()
        run: |
          echo "ğŸ“ Logs de STABLE:"
          docker logs --tail 50 serviciudadcali-stable || true
          
          echo ""
          echo "ğŸ“ Logs de CANARY:"
          docker logs --tail 50 serviciudadcali-canary || true

      # ============================================================
      # GUARDAR la imagen CANARY como STABLE para el prÃ³ximo workflow
      # ============================================================
      - name: ğŸ’¾ Guardar imagen CANARY como STABLE para prÃ³ximo despliegue
        if: success()
        run: |
          # La imagen canary (que acaba de pasar todas las pruebas)
          # se guardarÃ¡ como stable para el prÃ³ximo workflow
          docker tag serviciudadcali:canary serviciudadcali:stable
          
          # Guardar en archivo tar.gz
          mkdir -p stable-image-new
          docker save serviciudadcali:stable | gzip > stable-image-new/serviciudadcali-stable.tar.gz
          
          echo "âœ… Imagen CANARY guardada como STABLE para prÃ³ximo workflow"

      - name: ğŸ“¤ Subir imagen STABLE como artefacto persistente
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.STABLE_IMAGE_NAME }}
          path: stable-image-new/serviciudadcali-stable.tar.gz
          retention-days: 30
          overwrite: true

      - name: ğŸ“‹ Resumen de validaciÃ³n
        if: success()
        run: |
          if [ "${{ steps.check-stable.outputs.has_stable }}" == "true" ]; then
            echo "=========================================="
            echo "âœ… VALIDACIÃ“N CANARY EXITOSA"
            echo "=========================================="
            echo "ğŸ”— STABLE (vieja): http://localhost:8080 âœ…"
            echo "ğŸ”— CANARY (nueva): http://localhost:8081 âœ…"
            echo ""
            echo "ğŸ“Š Resultado: CANARY pasÃ³ todos los tests"
            echo "ğŸš€ Listo para deploy a producciÃ³n (Render)"
          else
            echo "=========================================="
            echo "âœ… PRIMER DESPLIEGUE EXITOSO"
            echo "=========================================="
            echo "ğŸ”— STABLE: http://localhost:8080 âœ…"
            echo ""
            echo "â„¹ï¸  En el prÃ³ximo push habrÃ¡ despliegue Canary"
          fi

  # ==============================================================
  # JOB 3: Deploy a Render (ProducciÃ³n)
  # ==============================================================
  deploy-to-render:
    name: ğŸš€ Deploy a ProducciÃ³n (Render)
    needs: [build-and-test, canary-validation]
    runs-on: ubuntu-latest
    # CAMBIO AQUÃ: Usar rama Vila en lugar de main
    if: github.event_name == 'push' && github.ref == 'refs/heads/Vila'
    
    steps:
      - name: ğŸš€ Trigger Render Deploy
        run: |
          echo "ğŸš€ Desplegando a Render..."
          echo "ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
          
          response=$(curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" -w "\n%{http_code}")
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… Deploy a Render iniciado exitosamente"
          else
            echo "âŒ Error al iniciar deploy (cÃ³digo: $http_code)"
            exit 1
          fi

      - name: â³ Esperar despliegue en Render
        run: |
          echo "â³ Esperando 60 segundos para que Render despliegue..."
          sleep 60

      - name: ğŸ” Verificar deploy en Render
        run: |
          echo "ğŸ” Verificando que la aplicaciÃ³n estÃ© disponible en Render..."
          
          # Reemplaza con tu URL de Render
          RENDER_URL="https://serviciudadcali.onrender.com"
          
          MAX_RETRIES=10
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f "${RENDER_URL}/actuator/health" 2>/dev/null; then
              echo "âœ… AplicaciÃ³n disponible en Render"
              curl "${RENDER_URL}/actuator/health"
              exit 0
            fi
            
            echo "â³ Intento $i/$MAX_RETRIES - Reintentando en 10s..."
            sleep 10
          done
          
          echo "âš ï¸  No se pudo verificar el deploy (puede tardar mÃ¡s)"
          echo "â„¹ï¸  Revisa manualmente: $RENDER_URL"

      - name: ğŸ‰ Deploy completado
        run: |
          echo "=========================================="
          echo "ğŸ‰ DEPLOY COMPLETADO EXITOSAMENTE"
          echo "=========================================="
          echo "ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ”— URL: https://serviciudadcali.onrender.com"
          echo ""
          echo "âœ… Pipeline Canary completado:"
          echo "  1. âœ… Tests y cobertura validados"
          echo "  2. âœ… Canary validado localmente"
          echo "  3. âœ… Desplegado a producciÃ³n (Render)"